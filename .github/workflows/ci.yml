name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: Code Quality
  code-quality:
    runs-on: ubuntu-latest
    name: Code Quality Checks
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install pylint black flake8 isort mypy bandit safety
          pip install -r streaming_pipeline/kafka/requirements.txt
          pip install -r batch_pipeline/data_modeling/requirements.txt
      
      - name: Format check with Black
        run: black --check streaming_pipeline/ batch_pipeline/
        continue-on-error: true
      
      - name: Lint with Pylint
        run: |
          pylint streaming_pipeline/kafka/*.py || true
          pylint batch_pipeline/data_modeling/*.py || true
        continue-on-error: true
      
      - name: Type check with mypy
        run: mypy streaming_pipeline/kafka/ batch_pipeline/data_modeling/ || true
        continue-on-error: true
      
      - name: Security scan with bandit
        run: |
          bandit -r streaming_pipeline/ batch_pipeline/ || true
        continue-on-error: true

  # Job 2: dbt Validation
  dbt-validation:
    runs-on: ubuntu-latest
    name: dbt Models Validation
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dbt
        run: pip install dbt-bigquery
      
      - name: dbt Parse
        working-directory: dbt
        run: dbt parse --profiles-dir .
      
      - name: dbt Compile
        working-directory: dbt
        run: dbt compile --profiles-dir .

  # Job 3: Terraform Validation
  terraform-validation:
    runs-on: ubuntu-latest
    name: Terraform Validation
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
      
      - name: Terraform Format Check
        run: terraform fmt -check -recursive terraform/
        continue-on-error: true
      
      - name: Terraform Validate
        working-directory: terraform/
        run: terraform init && terraform validate || true
        continue-on-error: true

  # Job 4: Unit Tests
  unit-tests:
    runs-on: ubuntu-latest
    name: Unit Tests
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install test dependencies
        run: |
          pip install pytest pytest-cov
          pip install -r streaming_pipeline/kafka/requirements.txt
          pip install -r batch_pipeline/data_modeling/requirements.txt
      
      - name: Create tests directory if missing
        run: mkdir -p tests && touch tests/__init__.py
      
      - name: Run tests
        run: pytest tests/ -v --cov=streaming_pipeline --cov=batch_pipeline || true
        continue-on-error: true

  # Job 5: Summary
  summary:
    runs-on: ubuntu-latest
    name: CI Summary
    needs: [code-quality, dbt-validation, terraform-validation, unit-tests]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.dbt-validation.result }}" = "failure" ]; then
            echo "⚠️ dbt validation failed"
          fi
          if [ "${{ needs.unit-tests.result }}" = "failure" ]; then
            echo "⚠️ Unit tests failed"
          fi
          echo "✅ CI Pipeline completed"
